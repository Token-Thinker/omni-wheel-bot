<!doctypehtml><html lang=en><meta charset=UTF-8><title>Controller</title><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"name=viewport><style>*{margin:0;padding:0;box-sizing:border-box}body,html{width:100vw;height:100vh;touch-action:none;margin:0;overflow:hidden;background-color:#121212;position:relative}body{scrollbar-width:none}</style><body><script>var VirtualJoystick=function(t){t=t||{},this._container=t.container||document.body,this._strokeStyle=t.strokeStyle||"cyan",this._stickEl=t.stickElement||this._buildJoystickStick(),this._baseEl=t.baseElement||this._buildJoystickBase(),this._mouseSupport=void 0!==t.mouseSupport&&t.mouseSupport,this._stationaryBase=t.stationaryBase||!1,this._baseX=this._stickX=t.baseX||0,this._baseY=this._stickY=t.baseY||0,this._limitStickTravel=t.limitStickTravel||!1,this._stickRadius=void 0!==t.stickRadius?t.stickRadius:100,this._useCssTransform=void 0!==t.useCssTransform&&t.useCssTransform,this._container.style.position="relative",this._container.appendChild(this._baseEl),this._baseEl.style.position="absolute",this._baseEl.style.display="none",this._container.appendChild(this._stickEl),this._stickEl.style.position="absolute",this._stickEl.style.display="none",this._pressed=!1,!(this._touchIdx=null)===this._stationaryBase&&(this._baseEl.style.display="",this._baseEl.style.left=this._baseX-this._baseEl.width/2+"px",this._baseEl.style.top=this._baseY-this._baseEl.height/2+"px"),this._transform=!!this._useCssTransform&&this._getTransformProperty(),this._has3d=this._check3D();var s=function(t,s){return function(){return t.apply(s,arguments)}};this._$onTouchStart=s(this._onTouchStart,this),this._$onTouchEnd=s(this._onTouchEnd,this),this._$onTouchMove=s(this._onTouchMove,this),this._container.addEventListener("touchstart",this._$onTouchStart,!1),this._container.addEventListener("touchend",this._$onTouchEnd,!1),this._container.addEventListener("touchmove",this._$onTouchMove,!1),this._mouseSupport&&(this._$onMouseDown=s(this._onMouseDown,this),this._$onMouseUp=s(this._onMouseUp,this),this._$onMouseMove=s(this._onMouseMove,this),this._container.addEventListener("mousedown",this._$onMouseDown,!1),this._container.addEventListener("mouseup",this._$onMouseUp,!1),this._container.addEventListener("mousemove",this._$onMouseMove,!1))};VirtualJoystick.prototype.destroy=function(){this._container.removeChild(this._baseEl),this._container.removeChild(this._stickEl),this._container.removeEventListener("touchstart",this._$onTouchStart,!1),this._container.removeEventListener("touchend",this._$onTouchEnd,!1),this._container.removeEventListener("touchmove",this._$onTouchMove,!1),this._mouseSupport&&(this._container.removeEventListener("mouseup",this._$onMouseUp,!1),this._container.removeEventListener("mousedown",this._$onMouseDown,!1),this._container.removeEventListener("mousemove",this._$onMouseMove,!1))},VirtualJoystick.touchScreenAvailable=function(){return"createTouch"in document},function(t){t.addEventListener=function(t,s){return void 0===this._events&&(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(s),s},t.removeEventListener=function(t,s){void 0===this._events&&(this._events={}),t in this._events&&this._events[t].splice(this._events[t].indexOf(s),1)},t.dispatchEvent=function(t){if(void 0===this._events&&(this._events={}),void 0!==this._events[t])for(var s=this._events[t].slice(),i=0;i<s.length;i++){var e=s[i].apply(this,Array.prototype.slice.call(arguments,1));if(void 0!==e)return e}}}(VirtualJoystick.prototype),VirtualJoystick.prototype.deltaX=function(){return this._stickX-this._baseX},VirtualJoystick.prototype.deltaY=function(){return this._stickY-this._baseY},VirtualJoystick.prototype.up=function(){if(!1===this._pressed)return!1;var t=this.deltaX(),s=this.deltaY();return!(0<=s)&&!(Math.abs(t)>2*Math.abs(s))},VirtualJoystick.prototype.down=function(){if(!1===this._pressed)return!1;var t=this.deltaX(),s=this.deltaY();return!(s<=0)&&!(Math.abs(t)>2*Math.abs(s))},VirtualJoystick.prototype.right=function(){if(!1===this._pressed)return!1;var t=this.deltaX(),s=this.deltaY();return!(t<=0)&&!(Math.abs(s)>2*Math.abs(t))},VirtualJoystick.prototype.left=function(){if(!1===this._pressed)return!1;var t=this.deltaX(),s=this.deltaY();return!(0<=t)&&!(Math.abs(s)>2*Math.abs(t))},VirtualJoystick.prototype._onUp=function(){this._pressed=!1,this._stickEl.style.display="none",0==this._stationaryBase&&(this._baseEl.style.display="none",this._baseX=this._baseY=0,this._stickX=this._stickY=0)},VirtualJoystick.prototype._onDown=function(t,s){if(this._pressed=!0,0==this._stationaryBase&&(this._baseX=t,this._baseY=s,this._baseEl.style.display="",this._move(this._baseEl.style,this._baseX-this._baseEl.width/2,this._baseY-this._baseEl.height/2)),this._stickX=t,this._stickY=s,!0===this._limitStickTravel){var i=this.deltaX(),e=this.deltaY(),o=Math.sqrt(i*i+e*e);if(o>this._stickRadius){var n=i/o,r=e/o;this._stickX=n*this._stickRadius+this._baseX,this._stickY=r*this._stickRadius+this._baseY}}this._stickEl.style.display="",this._move(this._stickEl.style,this._stickX-this._stickEl.width/2,this._stickY-this._stickEl.height/2)},VirtualJoystick.prototype._onMove=function(t,s){if(!0===this._pressed){if(this._stickX=t,this._stickY=s,!0===this._limitStickTravel){var i=this.deltaX(),e=this.deltaY(),o=Math.sqrt(i*i+e*e);if(o>this._stickRadius){var n=i/o,r=e/o;this._stickX=n*this._stickRadius+this._baseX,this._stickY=r*this._stickRadius+this._baseY}}this._move(this._stickEl.style,this._stickX-this._stickEl.width/2,this._stickY-this._stickEl.height/2)}},VirtualJoystick.prototype._onMouseUp=function(t){return this._onUp()},VirtualJoystick.prototype._onMouseDown=function(t){t.preventDefault();var s=t.clientX,i=t.clientY;return this._onDown(s,i)},VirtualJoystick.prototype._onMouseMove=function(t){var s=t.clientX,i=t.clientY;return this._onMove(s,i)},VirtualJoystick.prototype._onTouchStart=function(t){if(null===this._touchIdx&&!1!==this.dispatchEvent("touchStartValidation",t)){this.dispatchEvent("touchStart",t),t.preventDefault();var s=t.changedTouches[0];this._touchIdx=s.identifier;var i=s.pageX,e=s.pageY;return this._onDown(i,e)}},VirtualJoystick.prototype._onTouchEnd=function(t){if(null!==this._touchIdx){this.dispatchEvent("touchEnd",t);for(var s=t.changedTouches,i=0;i<s.length&&s[i].identifier!==this._touchIdx;i++);if(i!==s.length)return this._touchIdx=null,t.preventDefault(),this._onUp()}},VirtualJoystick.prototype._onTouchMove=function(t){if(null!==this._touchIdx){for(var s=t.changedTouches,i=0;i<s.length&&s[i].identifier!==this._touchIdx;i++);if(i!==s.length){var e=s[i];t.preventDefault();var o=e.pageX,n=e.pageY;return this._onMove(o,n)}}},VirtualJoystick.prototype._buildJoystickBase=function(){var t=document.createElement("canvas");t.width=126,t.height=126;var s=t.getContext("2d");return s.beginPath(),s.strokeStyle=this._strokeStyle,s.lineWidth=6,s.arc(t.width/2,t.width/2,40,0,2*Math.PI,!0),s.stroke(),s.beginPath(),s.strokeStyle=this._strokeStyle,s.lineWidth=2,s.arc(t.width/2,t.width/2,60,0,2*Math.PI,!0),s.stroke(),t},VirtualJoystick.prototype._buildJoystickStick=function(){var t=document.createElement("canvas");t.width=86,t.height=86;var s=t.getContext("2d");return s.beginPath(),s.strokeStyle=this._strokeStyle,s.lineWidth=6,s.arc(t.width/2,t.width/2,40,0,2*Math.PI,!0),s.stroke(),t},VirtualJoystick.prototype._move=function(t,s,i){this._transform?this._has3d?t[this._transform]="translate3d("+s+"px,"+i+"px, 0)":t[this._transform]="translate("+s+"px,"+i+"px)":(t.left=s+"px",t.top=i+"px")},VirtualJoystick.prototype._getTransformProperty=function(){for(var t,s=["webkitTransform","MozTransform","msTransform","OTransform","transform"],i=document.createElement("p"),e=0;e<s.length;e++)if(t=s[e],null!=i.style[t])return t},VirtualJoystick.prototype._check3D=function(){var t=this._getTransformProperty();if(!t||!window.getComputedStyle)return module.exports=!1;var s=document.createElement("div");s.style[t]="translate3d(1px,1px,1px)",document.body.insertBefore(s,null);var i=getComputedStyle(s).getPropertyValue({webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"}[t]);return document.body.removeChild(s),null!=i&&i.length&&"none"!=i}</script><script>document.addEventListener('DOMContentLoaded',()=>{document.body.style.userSelect='none';document.body.style.MozUserSelect='none';document.body.style.msUserSelect='none';});const currentPath=window.location.pathname;let WS_URL=(window.location.protocol==="https:")?"wss:":"ws:";WS_URL+="//"+window.location.host;WS_URL+=currentPath.slice(0,currentPath.lastIndexOf("/")+1)+"ws";const RECONNECT_INTERVAL=15000;const SEND_INTERVAL=1000/30;class WebSocketManager{constructor(url){this.url=url;this.socket=null;this.initializeWebSocket();}initializeWebSocket(){this.socket=new WebSocket(this.url,["messages"]);this.socket.onopen=()=>{console.log('connected');};this.socket.onmessage=(event)=>{console.log('message:',event.data);};this.socket.onerror=(error)=>{console.error('error:',error);};this.socket.onclose=()=>{console.log('closed');this.scheduleReconnect();};}scheduleReconnect(){console.log(`Reconnecting in ${RECONNECT_INTERVAL/1000} seconds...`);setTimeout(()=>{if(this.socket.readyState===WebSocket.CLOSED){console.log('Reconnecting...');this.initializeWebSocket();}},RECONNECT_INTERVAL);}sendCommand(commandObj){const jsonCommand=JSON.stringify(commandObj);console.log('Sending:',jsonCommand);if(this.socket.readyState===WebSocket.OPEN){this.socket.send(jsonCommand);console.log('Sent:',jsonCommand);}else{console.warn('Cannot send message:',jsonCommand);}}}const wsManager=new WebSocketManager(WS_URL);window.joystickActive=false;class JoystickController{constructor(options){this.joystick=new VirtualJoystick(options);this.initializeEvents();this.dragging=false;this.startX=0;this.startY=0;this.ACTIVATE_THRESHOLD=20;}initializeEvents(){this.joystick.addEventListener('touchStartValidation',this.validateTouchStart.bind(this));this.joystick.addEventListener('touchStart',this.onTouchStart.bind(this));this.joystick.addEventListener('touchEnd',this.onTouchEnd.bind(this));this.joystick.addEventListener('touchMove',this.onTouchMove.bind(this));}validateTouchStart(event){}onTouchStart(event){const touch=event.changedTouches?event.changedTouches[0]:event;this.startX=touch.pageX;this.startY=touch.pageY;this.dragging=false;}onTouchEnd(){if(this.dragging){window.joystickActive=false;}this.dragging=false;}onTouchMove(event){if(!this.dragging){const touch=event.changedTouches?event.changedTouches[0]:event;const dx=touch.pageX-this.startX;const dy=touch.pageY-this.startY;const dist=Math.sqrt(dx*dx+dy*dy);if(dist>this.ACTIVATE_THRESHOLD){this.dragging=true;window.joystickActive=true;}}}}class LeftJoystick extends JoystickController{constructor(){super({container:document.body,strokeStyle:'blue',limitStickTravel:true,stickRadius:120,mouseSupport:false,});this.previousCommand={s:null,o:null};}validateTouchStart(event){const touch=event.changedTouches[0];return touch.pageX<window.innerWidth/2;}onTouchEnd(){super.onTouchEnd();if(this.dragging){wsManager.sendCommand({ct:"i",ic:"y",s:0,o:null});}}getCommand(){const speed=parseFloat(calculateYawSpeed(this.joystick.deltaX(),this.joystick.deltaY()));const orientation=null;return{ct:"i",ic:"y",s:speed,o:orientation};}}class RightJoystick extends JoystickController{constructor(){super({container:document.body,strokeStyle:'white',limitStickTravel:true,stickRadius:120,mouseSupport:true,});this.previousCommand={d:null,s:null};}validateTouchStart(event){const touch=event.changedTouches[0];return touch.pageX>=window.innerWidth/2;}onTouchEnd(){super.onTouchEnd();if(this.dragging){wsManager.sendCommand({ct:"i",ic:"t",d:0,s:0});}}getCommand(){const{speed,direction}=calculateMove(this.joystick.deltaX(),this.joystick.deltaY());return{ct:"i",ic:"t",d:direction,s:speed};}}const leftJoystick=new LeftJoystick();const rightJoystick=new RightJoystick();function calculateYawSpeed(deltaX,deltaY){const magnitude=Math.sqrt(deltaX**2+deltaY**2);const normalizedMagnitude=Math.min(1,magnitude/120);const sign=deltaX>=0?1:-1;const yawSpeed=sign*normalizedMagnitude;return yawSpeed.toFixed(1);}function calculateMove(deltaX,deltaY){const magnitude=Math.sqrt(deltaX**2+deltaY**2);const normalizedMagnitude=Math.min(1,magnitude/120);let angle=(Math.atan2(deltaY,deltaX)*(180/Math.PI))+90;angle=(angle+360)%360;const speed=magnitude===0?0:parseFloat(normalizedMagnitude.toFixed(2));const direction=magnitude===0?0:Math.round(angle);return{speed,direction};}let previousYCommand={s:null,o:null};let previousTCommand={d:null,s:null};setInterval(()=>{const currentY=leftJoystick.getCommand();const currentT=rightJoystick.getCommand();if(currentY.s!==previousYCommand.s||currentY.o!==previousYCommand.o){wsManager.sendCommand(currentY);previousYCommand={...currentY};console.log('Yaw:',currentY);}if(currentT.d!==previousTCommand.d||currentT.s!==previousTCommand.s){wsManager.sendCommand(currentT);previousTCommand={...currentT};console.log('Move:',currentT);}},SEND_INTERVAL);const DOUBLE_TAP_THRESHOLD=300;const LONG_PRESS_THRESHOLD=1000;const MOVE_THRESHOLD=20;let lastTapTimeLeft=0;let lastTapTimeRight=0;let isLightsOn=false;let startX=0;let startY=0;let touchStartTime=0;let touchSide=null;let touchMoved=false;let longPressTimer=null;function onGlobalTouchStart(event){if(window.joystickActive)return;const touch=event.changedTouches?event.changedTouches[0]:event;startX=touch.pageX;startY=touch.pageY;touchStartTime=Date.now();touchMoved=false;touchSide=(touch.pageX<window.innerWidth/2)?'left':'right';longPressTimer=setTimeout(()=>{if(touchSide==='left'){console.log('Long press on LEFT');wsManager.sendCommand({POWER_LEFT:'TOGGLE'});}else{console.log('Long press on RIGHT');wsManager.sendCommand({POWER_RIGHT:'TOGGLE'});}longPressTimer=null;},LONG_PRESS_THRESHOLD);}function onGlobalTouchMove(event){if(window.joystickActive)return;const touch=event.changedTouches?event.changedTouches[0]:event;const deltaX=touch.pageX-startX;const deltaY=touch.pageY-startY;const dist=Math.sqrt(deltaX*deltaX+deltaY*deltaY);if(dist>MOVE_THRESHOLD){touchMoved=true;if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}}}function onGlobalTouchEnd(event){if(window.joystickActive)return;if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}if(touchMoved)return;const now=Date.now();if(touchSide==='left'){if(now-lastTapTimeLeft<DOUBLE_TAP_THRESHOLD){console.log('DTL');if(isLightsOn){wsManager.sendCommand({ct:"l",lc:"off"});isLightsOn=false;}else{wsManager.sendCommand({ct:"l",lc:"on"});isLightsOn=true;}lastTapTimeLeft=0;}else{lastTapTimeLeft=now;}}else{if(now-lastTapTimeRight<DOUBLE_TAP_THRESHOLD){console.log('DTR');wsManager.sendCommand({LIGHTS_RIGHT:'TOGGLE'});lastTapTimeRight=0;}else{lastTapTimeRight=now;}}}document.addEventListener('touchstart',onGlobalTouchStart,{passive:false});document.addEventListener('touchmove',onGlobalTouchMove,{passive:false});document.addEventListener('touchend',onGlobalTouchEnd,{passive:false});document.addEventListener('mousedown',onGlobalTouchStart);document.addEventListener('mousemove',onGlobalTouchMove);document.addEventListener('mouseup',onGlobalTouchEnd);</script>
